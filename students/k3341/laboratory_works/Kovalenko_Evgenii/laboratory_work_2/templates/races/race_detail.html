{% extends 'base.html' %}

{% block title %}{{ race.name }} - Racing Championship{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–æ–Ω–∫–µ -->
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="card-title mb-0">{{ race.name }}</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>üìç –ú–µ—Å—Ç–æ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:</strong> {{ race.location }}</p>
                        <p><strong>üìÖ –î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</strong> {{ race.start_date|date:"d.m.Y H:i" }}</p>
                        <p><strong>üìÖ –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</strong> {{ race.end_date|date:"d.m.Y H:i" }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>üéØ –¢–∏–ø –≥–æ–Ω–∫–∏:</strong> {{ race.get_race_type_display }}</p>
                        <p><strong>üìä –°—Ç–∞—Ç—É—Å:</strong>
                            {% if race.is_active %}
                            <span class="badge bg-success">–ê–∫—Ç–∏–≤–Ω–∞—è</span>
                            {% else %}
                            <span class="badge bg-secondary">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                            {% endif %}
                        </p>
                    </div>
                </div>

                {% if race.description %}
                <hr>
                <h5>–û–ø–∏—Å–∞–Ω–∏–µ –≥–æ–Ω–∫–∏:</h5>
                <p>{{ race.description|linebreaks }}</p>
                {% endif %}

                <div class="mt-4">
                    {% if user.is_authenticated and user.racer %}
                        {% if is_registered %}
                        <div class="alert alert-success">
                            ‚úÖ –í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –Ω–∞ —ç—Ç—É –≥–æ–Ω–∫—É
                        </div>
                        {% elif race.is_active %}
                        <a href="{% url 'race_register' race.id %}" class="btn btn-success">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –≥–æ–Ω–∫—É</a>
                        {% else %}
                        <button class="btn btn-secondary" disabled>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∞</button>
                        {% endif %}
                    {% elif user.is_authenticated %}
                        <div class="alert alert-info">
                            –î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –≥–æ–Ω–∫—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –≥–æ–Ω—â–∏–∫–∞.
                            <a href="{% url 'create_racer_profile' %}" class="alert-link">–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</a>
                        </div>
                    {% else %}
                        <div class="alert alert-warning">
                            –î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ –≥–æ–Ω–∫—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ <a href="{% url 'login' %}" class="alert-link">–≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a>.
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏</h5>
            </div>
            <div class="card-body">
                {% if registrations %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–ì–æ–Ω—â–∏–∫</th>
                                <th>–ö–æ–º–∞–Ω–¥–∞</th>
                                <th>–ê–≤—Ç–æ–º–æ–±–∏–ª—å</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for registration in registrations %}
                            <tr>
                                <td>{{ registration.racer.user.get_full_name }}</td>
                                <td>{{ registration.racer.team.name|default:"-" }}</td>
                                <td>{{ registration.car.model }}</td>
                                <td>
                                    {% if registration.is_confirmed %}
                                    <span class="badge bg-success">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</span>
                                    {% else %}
                                    <span class="badge bg-warning">–û–∂–∏–¥–∞–µ—Ç</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                {% endif %}
            </div>
        </div>

        <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ–Ω–∫–∏ -->
        {% if results %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–æ–Ω–∫–∏</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>–ü–æ–∑–∏—Ü–∏—è</th>
                                <th>–ì–æ–Ω—â–∏–∫</th>
                                <th>–û—á–∫–∏</th>
                                <th>–õ—É—á—à–∏–π –∫—Ä—É–≥</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for result in results %}
                            <tr>
                                <td>
                                    {% if result.position %}
                                    {{ result.position }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>{{ result.race_registration.racer.user.get_full_name }}</td>
                                <td>{{ result.points }}</td>
                                <td>
                                    {% if result.best_lap_time %}
                                    {{ result.best_lap_time }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if result.dnf %}
                                    <span class="badge bg-danger">DNF</span>
                                    {% else %}
                                    <span class="badge bg-success">–§–∏–Ω–∏—à–∏—Ä–æ–≤–∞–ª</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <div class="col-lg-4">
        <!-- –§–æ—Ä–º–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
        {% if user.is_authenticated %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h5>
            </div>
            <div class="card-body">
                <form method="post" action="{% url 'add_comment' race.id %}">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="id_text" class="form-label">–¢–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è</label>
                        <textarea name="text" class="form-control" id="id_text" rows="4" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_comment_type" class="form-label">–¢–∏–ø –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è</label>
                                <select name="comment_type" class="form-select" id="id_comment_type" required>
                                    {% for value, label in comment_form.fields.comment_type.choices %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_rating" class="form-label">–†–µ–π—Ç–∏–Ω–≥ (1-10)</label>
                                <input type="number" name="rating" class="form-control" id="id_rating" min="1" max="10" required>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
                </form>
            </div>
        </div>
        {% else %}
        <div class="card mb-4">
            <div class="card-body text-center">
                <p>–î–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ <a href="{% url 'login' %}">–≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</a></p>
            </div>
        </div>
        {% endif %}

        <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ ({{ comments.count }})</h5>
            </div>
            <div class="card-body">
                {% if comments %}
                    {% for comment in comments %}
                    <div class="border-bottom pb-3 mb-3">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="mb-1">{{ comment.author.get_full_name }}</h6>
                            <small class="text-muted">{{ comment.comment_date|date:"d.m.Y H:i" }}</small>
                        </div>
                        <p class="mb-1">{{ comment.text }}</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-secondary">{{ comment.get_comment_type_display }}</span>
                            <span class="text-warning">‚òÖ {{ comment.rating }}/10</span>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <p class="text-muted text-center">–ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}