{% extends 'base.html' %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≥–æ–Ω–∫–∏ - Racing Championship{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ –≥–æ–Ω–∫–∏</h1>
        <a href="{% url 'race_detail' race.id %}" class="btn btn-outline-primary">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≥–æ–Ω–∫–µ</a>
    </div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥–æ–Ω–∫–µ -->
    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">{{ race.name }}</h5>
            <div class="row">
                <div class="col-md-4">
                    <p><strong>üìç –ú–µ—Å—Ç–æ:</strong> {{ race.location }}</p>
                </div>
                <div class="col-md-4">
                    <p><strong>üìÖ –î–∞—Ç–∞:</strong> {{ race.start_date|date:"d.m.Y H:i" }}</p>
                </div>
                <div class="col-md-4">
                    <p><strong>üéØ –¢–∏–ø:</strong> {{ race.get_race_type_display }}</p>
                </div>
            </div>
            <p class="mb-0"><strong>–£—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> {{ registrations|length }}</p>
        </div>
    </div>

    <!-- –§–æ—Ä–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏ -->
    <div class="card">
        <div class="card-header">
            <h5 class="card-title mb-0">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h5>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}

                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead class="table-dark">
                            <tr>
                                <th>–ü–æ–∑–∏—Ü–∏—è</th>
                                <th>–ì–æ–Ω—â–∏–∫</th>
                                <th>–ö–æ–º–∞–Ω–¥–∞</th>
                                <th>–ê–≤—Ç–æ–º–æ–±–∏–ª—å</th>
                                <th>–í—Ä–µ–º—è —Ñ–∏–Ω–∏—à–∞</th>
                                <th>–õ—É—á—à–∏–π –∫—Ä—É–≥</th>
                                <th>–û—á–∫–∏</th>
                                <th>–°—Ç–∞—Ç—É—Å</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for registration in registrations %}
                            {% with result=registration.raceresult %}
                            <tr>
                                <td>
                                    <input type="number" name="position_{{ registration.id }}"
                                           value="{{ result.position|default:'' }}"
                                           class="form-control form-control-sm"
                                           min="1" max="{{ registrations|length }}"
                                           placeholder="-">
                                </td>
                                <td>
                                    <strong>{{ registration.racer.user.get_full_name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ registration.racer.get_racer_class_display }}</small>
                                </td>
                                <td>
                                    {% if registration.racer.team %}
                                    {{ registration.racer.team.name }}
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td>{{ registration.car.model }}</td>
                                <td>
                                    <input type="text" name="finish_time_{{ registration.id }}"
                                           value="{{ result.finish_time|default:'' }}"
                                           class="form-control form-control-sm"
                                           placeholder="HH:MM:SS">
                                </td>
                                <td>
                                    <input type="text" name="best_lap_time_{{ registration.id }}"
                                           value="{{ result.best_lap_time|default:'' }}"
                                           class="form-control form-control-sm"
                                           placeholder="HH:MM:SS">
                                </td>
                                <td>
                                    <input type="number" name="points_{{ registration.id }}"
                                           value="{{ result.points|default:0 }}"
                                           class="form-control form-control-sm"
                                           min="0" max="100">
                                </td>
                                <td>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox"
                                               name="dnf_{{ registration.id }}"
                                               {% if result.dnf %}checked{% endif %}>
                                        <label class="form-check-label">
                                            {% if result.dnf %}
                                            <span class="badge bg-danger">DNF</span>
                                            {% else %}
                                            <span class="badge bg-success">–§–∏–Ω–∏—à–∏—Ä–æ–≤–∞–ª</span>
                                            {% endif %}
                                        </label>
                                    </div>
                                </td>
                            </tr>
                            {% endwith %}
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <p class="text-muted">–ù–µ—Ç –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if registrations %}
                <div class="mt-4">
                    <div class="alert alert-warning">
                        <h6>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—é:</h6>
                        <ul class="mb-0">
                            <li><strong>–ü–æ–∑–∏—Ü–∏—è:</strong> –º–µ—Å—Ç–æ –≥–æ–Ω—â–∏–∫–∞ –≤ –≥–æ–Ω–∫–µ (1 - –ø–µ—Ä–≤–æ–µ –º–µ—Å—Ç–æ)</li>
                            <li><strong>–í—Ä–µ–º—è —Ñ–∏–Ω–∏—à–∞:</strong> –æ–±—â–µ–µ –≤—Ä–µ–º—è –≥–æ–Ω–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM:SS</li>
                            <li><strong>–õ—É—á—à–∏–π –∫—Ä—É–≥:</strong> –ª—É—á—à–µ–µ –≤—Ä–µ–º—è –∫—Ä—É–≥–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ HH:MM:SS</li>
                            <li><strong>–û—á–∫–∏:</strong> –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–∞–±—Ä–∞–Ω–Ω—ã—Ö –æ—á–∫–æ–≤ –ø–æ —Å–∏—Å—Ç–µ–º–µ —á–µ–º–ø–∏–æ–Ω–∞—Ç–∞</li>
                            <li><strong>DNF:</strong> –æ—Ç–º–µ—Ç—å—Ç–µ, –µ—Å–ª–∏ –≥–æ–Ω—â–∏–∫ –Ω–µ —Ñ–∏–Ω–∏—à–∏—Ä–æ–≤–∞–ª</li>
                        </ul>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="submit" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
                    </div>
                </div>
                {% endif %}
            </form>
        </div>
    </div>

    <!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
    {% if registrations %}
    <div class="card mt-4">
        <div class="card-header">
            <h5 class="card-title mb-0">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h5>
        </div>
        <div class="card-body">
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary" onclick="autoFillPositions()">
                    –ê–≤—Ç–æ—Ä–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–æ–∑–∏—Ü–∏–π
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="clearAllResults()">
                    –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                </button>
                <a href="{% url 'admin:racing_app_race_change' race.id %}"
                   class="btn btn-outline-info" target="_blank">
                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–æ–Ω–∫—É –≤ –∞–¥–º–∏–Ω–∫–µ
                </a>
            </div>
        </div>
    </div>
    {% endif %}
</div>

{% if registrations %}
<script>
function autoFillPositions() {
    const positionInputs = document.querySelectorAll('input[name^="position_"]');
    positionInputs.forEach((input, index) => {
        if (!input.value) {
            input.value = index + 1;
        }
    });
}

function clearAllResults() {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
        const inputs = document.querySelectorAll('input[type="number"], input[type="text"]');
        inputs.forEach(input => {
            if (input.name !== 'csrfmiddlewaretoken') {
                input.value = '';
            }
        });

        const checkboxes = document.querySelectorAll('input[type="checkbox"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
    }
}

// –ê–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—á–∫–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–∑–∏—Ü–∏–∏
document.addEventListener('DOMContentLoaded', function() {
    const positionInputs = document.querySelectorAll('input[name^="position_"]');
    positionInputs.forEach(input => {
        input.addEventListener('change', function() {
            const position = parseInt(this.value);
            if (position && position >= 1 && position <= 10) {
                // –°–∏—Å—Ç–µ–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –æ—á–∫–æ–≤ (–º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å)
                const pointsMap = {
                    1: 25, 2: 18, 3: 15, 4: 12, 5: 10,
                    6: 8, 7: 6, 8: 4, 9: 2, 10: 1
                };

                const registrationId = this.name.split('_')[1];
                const pointsInput = document.querySelector(`input[name="points_${registrationId}"]`);
                if (pointsInput && !pointsInput.value) {
                    pointsInput.value = pointsMap[position] || 0;
                }
            }
        });
    });
});
</script>
{% endif %}

<style>
.table th {
    font-weight: 600;
    font-size: 0.875rem;
}

.form-control-sm {
    min-width: 80px;
}

input[type="number"] {
    text-align: center;
}

.badge {
    font-size: 0.75rem;
}
</style>
{% endblock %}